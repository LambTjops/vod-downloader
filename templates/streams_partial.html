<div id="status-bar-container" style="width: 100%; margin-bottom: 2rem;">
    {% include 'progress_bar.html' ignore missing %}
</div>

{% if items|length == 0 %}
<div style="text-align: center; padding: 3rem; color: #94a3b8;">
    <p style="font-size: 1.1rem;">No items found in this category.</p>
</div>
{% else %}
{% for item in items %}
<article>
    <header>
        <strong>{{ item.name }}</strong>
    </header>
    
    {% set img_url = item.stream_icon or item.cover or "" %}
    
    {% if img_url != "" %}
        <img src="{{ img_url }}" loading="lazy" alt="{{ item.name }}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
        <div style="height: 320px; background: linear-gradient(135deg, #1e293b 0%, #334155 100%); display: none; align-items: center; justify-content: center; color: #94a3b8; font-size: 0.9rem;">
            <span>üìΩÔ∏è No Image</span>
        </div>
    {% else %}
        <div style="height: 320px; background: linear-gradient(135deg, #1e293b 0%, #334155 100%); display: flex; align-items: center; justify-content: center; color: #94a3b8; font-size: 0.9rem;">
            <span>üìΩÔ∏è No Image</span>
        </div>
    {% endif %}
    
    <footer>
        {% if type == "movie" %}
            {% set item_id = "movie:" ~ item.stream_id %}
            
            {% if item_id in queued_items %}
                <button 
                    disabled
                    style="width: 100%; padding: 0.75rem 1rem; border-radius: 8px; font-weight: 500; border: 1.5px solid #10b981; background: rgba(16, 185, 129, 0.1); color: #10b981; cursor: not-allowed; opacity: 0.8;">
                    ‚úì Already in Queue
                </button>
            {% elif item._is_downloaded %}
                <button 
                    disabled
                    style="width: 100%; padding: 0.75rem 1rem; border-radius: 8px; font-weight: 500; border: 1.5px solid #3b82f6; background: rgba(59, 130, 246, 0.1); color: #3b82f6; cursor: not-allowed; opacity: 0.8;">
                    ‚úì Already Downloaded
                </button>
            {% else %}
                <div style="display: flex; gap: 0.5rem;">
                    <button 
                        hx-get="/queue/add/movie/{{ item.stream_id }}/{{ item.container_extension }}?title={{ item.name }}"
                        hx-target="#status-bar-container"
                        hx-swap="innerHTML"
                        hx-on::after-request="if(event.detail.xhr.status === 200) { updateMovieButton(this, '{{ item_id }}'); if(typeof refreshQueue === 'function') refreshQueue(); }"
                        class="secondary outline"
                        style="flex: 1; padding: 0.75rem 1rem; border-radius: 8px; font-weight: 500; transition: all 0.2s ease; border: 1.5px solid #334155; background: transparent; color: #f1f5f9; cursor: pointer;"
                        onmouseover="if(!this.disabled) { this.style.borderColor='#667eea'; this.style.color='#667eea'; this.style.background='rgba(102, 126, 234, 0.1)'; }"
                        onmouseout="if(!this.disabled) { this.style.borderColor='#334155'; this.style.color='#f1f5f9'; this.style.background='transparent'; }">
                        üì• Add to Queue
                    </button>
                    <button 
                        onclick="markMovieAsDownloaded('movie', '{{ item.stream_id }}', this, '{{ item_id }}')"
                        style="padding: 0.75rem; border-radius: 8px; font-weight: 500; border: 1.5px solid #3b82f6; background: transparent; color: #3b82f6; cursor: pointer; transition: all 0.2s ease;"
                        onmouseover="this.style.background='rgba(59, 130, 246, 0.1)';"
                        onmouseout="this.style.background='transparent';"
                        title="Mark as Downloaded">
                        ‚úì
                    </button>
                </div>
            {% endif %}
        
        {% else %}
            <button 
                hx-get="/episodes/{{ item.series_id }}"
                hx-target="#stream-list"
                hx-swap="innerHTML"
                class="primary"
                style="width: 100%; padding: 0.75rem 1rem; border-radius: 8px; font-weight: 500; transition: all 0.2s ease; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; cursor: pointer;"
                onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)';"
                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                ‚ñ∂Ô∏è View Episodes
            </button>
        {% endif %}
    </footer>
</article>
{% endfor %}
{% endif %}

<script>
function updateMovieButton(button, itemId) {
    const article = button.closest('article');
    const footer = article.querySelector('footer');
    footer.innerHTML = `
        <button 
            disabled
            style="width: 100%; padding: 0.75rem 1rem; border-radius: 8px; font-weight: 500; border: 1.5px solid #10b981; background: rgba(16, 185, 129, 0.1); color: #10b981; cursor: not-allowed; opacity: 0.8;">
            ‚úì Already in Queue
        </button>
    `;
}

function markMovieAsDownloaded(kind, id, button, itemId) {
    if (!confirm('Mark this movie as downloaded? This will prevent it from being queued again.')) return;
    
    const originalHTML = button.innerHTML;
    button.disabled = true;
    button.innerHTML = '‚è≥';
    
    fetch(`/queue/mark_downloaded/${kind}/${id}`, {method: 'POST'})
        .then(r => r.json())
        .then(data => {
            // Update the entire footer without redirect
            const article = button.closest('article');
            const footer = article.querySelector('footer');
            footer.innerHTML = `
                <button 
                    disabled
                    style="width: 100%; padding: 0.75rem 1rem; border-radius: 8px; font-weight: 500; border: 1.5px solid #3b82f6; background: rgba(59, 130, 246, 0.1); color: #3b82f6; cursor: not-allowed; opacity: 0.8;">
                    ‚úì Already Downloaded
                </button>
            `;
        })
        .catch(err => {
            console.error('Error marking as downloaded:', err);
            alert('Error marking as downloaded. Check console for details.');
            button.disabled = false;
            button.innerHTML = originalHTML;
        });
}
</script>
